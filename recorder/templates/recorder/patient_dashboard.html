{% extends 'base.html' %}

{% block title %}memocha Patient Dashboard{%  endblock title %}

{% block extra-head %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'recorder/patient_dashboard.css' %}" />
{% endblock extra-head %}

{% block content %}
    <h2>Personal Information for {{ patient.user.first_name }} {{ patient.user.last_name }}</h2>
    <p>Date of birth: {{ patient.date_of_birth }}</p>
    <p>Email Address: {{ patient.user.email }}</p>
    <p>Doctor: {{ patient.doctor.user.first_name }} {{ patient.doctor.user.last_name }}</p>

    <form id="current_meds" method="post" action="{% url 'recorder:record_video' %}">
        {% csrf_token %}
    </form>

    <h2>Prescriptions</h2>
    {% for prescription in patient.prescriptions.all %}
        <p>{{ prescription }}</p>
    {% endfor %}

    <h2>Videos for Last 5 Days</h2>
    <div class="table-responsive">
        <table id="video_table" class="table">
        </table>
    </div>
{% endblock content %}

{% block extra-js %}
    <script type="text/javascript">
        $(function() {
            var med_div = document.getElementById("current_meds");
            var recordables = {{ recordable_meds|safe }};
            if (recordables.length > 0) {
                var medications = {{ recordable_meds|safe }};
                var time = {{ recordable_med_times|safe }};
                var heading = document.createTextNode("Recordable Medications");
                var node = document.createElement("H2");
                node.appendChild(heading);
                med_div.appendChild(node);
                for (i=0; i < medications.length; i++) {
                    node = document.createElement("P");
                    par = document.createTextNode(medications[i] + " at " + time[i]);
                    node.appendChild(par);
                    med_div.appendChild(node);
                    node = document.createElement("button");
                    node.innerHTML = "Record Medication";
                    node.setAttribute('name', 'medication');
                    node.setAttribute('value', medications[i]);
                    node.classList.add('btn', 'btn-primary');
                    med_div.appendChild(node);
                }
            } else {
                medications = {{ next_meds|safe }};
                time = ["{{ next_med_time|safe }}"];
                heading = document.createTextNode("Next Medication");
                node = document.createElement("H2");
                node.appendChild(heading);
                med_div.appendChild(node);
                for (i=0; i < medications.length; i++) {
                    node = document.createElement("P");
                    par = document.createTextNode(medications[i] + " at " + time[i]);
                    node.appendChild(par);
                    med_div.appendChild(node);
                }
            }

            var dates = {{ dates_of_interest|safe }};

            var table = document.getElementById("video_table");
            var header = table.createTHead();
            var row = header.insertRow(-1);
            var header_cells = ["Medication"].concat(dates);
            for (i=0; i < header_cells.length; i++) {
                var cell = row.insertCell(-1);
                cell.innerHTML = header_cells[i];
            }
            var prescriptions = {{ prescriptions|safe }};
            for (i=0; i < prescriptions.length; i++) {
                var prescription = prescriptions[i];
                row = table.insertRow(-1);
                cell = row.insertCell(-1);
                cell.innerHTML = prescription[1];
                for (j=1; j < header_cells.length; j++) {
                    cell = row.insertCell(-1);
                    var times = prescription[3];
                    for (k=0; k < times.length; k++) {
                        var real_time = times[k].substring(0, times[k].length - 3);
                        node = document.createElement("P");
                        node.innerHTML = real_time;
                        node.classList.add('no-video');
                        cell.appendChild(node);
                    }
                }
            }

            var videos = {{ video_list|safe }};
            table = $("#video_table");
            for (i=0; i < videos.length; i++) {
                var video = videos[i];
                row = table.find("tr:contains("+ video.medication +")")[0];
                column = table.find("td:contains("+ video.date +")").index();
                cell = row.cells[column];
                node = $(cell).find("p:contains("+ video.timeslot +")");
                new_node = document.createElement("A");
                new_node.innerHTML = video.timeslot;
                new_node.href = video.url;
                if (video.approved === true) {
                    new_node.classList.add('yes-video');
                } else if (video.approved === false) {
                    new_node.classList.add('no-video');
                } else {
                    new_node.classList.add('maybe-video');
                }
                $(node).replaceWith(new_node);
            }
        });
    </script>
{% endblock extra-js %}
